CHIP		SN8P2501D
//{{SONIX_CODE_OPTION
	.Code_Option	Noise_Filter	Enable
	.Code_Option	Reset_Pin	P11
	.Code_Option	Watch_Dog	Disable
	.Code_Option	High_Clk	IHRC_RTC	;
	.Code_Option	Fcpu		#3     ; Fcpu = Fosc/8
	.Code_Option	Security	Enable
	.Code_Option	LVD		LVD_L		;
//}}SONIX_CODE_OPTION

.nolist				
	INCLUDESTD		MACRO1.H
	INCLUDESTD		MACRO2.H
	INCLUDESTD		MACRO3.H
.list
	END_RAM_ADDR	EQU	0X2F
	EER_ADD			EQU	0XA1	;10100001B
	EEW_ADD			EQU	0XA0	;10100000B
	RAM_COUNT		EQU	48
	TM_DATA_H		EQU	0X34	;ADDR OF THE TEMPEATURE	OF TM
	TM_DATA_L		EQU	0X00
	TIME_GAP		EQU	0X78	;0X78
	T0_TDR			EQU	0X01
	TMR_ADD 		EQU	0X3D
	TMW_ADD			EQU	0X3C
	MAX_MEMH		EQU	0X1F
	MAX_MEML		EQU	0XF0
	LAST_TIME_EE_ADD_H EQU 0X1F
	LAST_TIME_EE_ADD_L EQU 0XFE
	LIVE_TIME_ADD_H		EQU	0X1F
	LIVE_TIME_ADD_L		EQU	0XFC
	DEFAULT_FRONT_TIME_DELAY	EQU	0X01
	DEFAULT_TIME_GAP	EQU	0X01
	TM_TIME_H		EQU	0X2E
	TM_TIME_L		EQU	0X00
	WRITE_TM_ADD_H	EQU	0X2F
	WRITE_TM_ADD_L	EQU	0X00
	WRITE_FLAG_H	EQU 0X01
	WRITE_FLAG_L	EQU	0X00
	DEFAULT_GAP_TIME_FLAGH EQU 0X02
	DEFAULT_GAP_TIME_FLAGL EQU	0X00
.DATA
			ORG	0H
	DELAYTIME1	DS	1
	DELAYTIME2	DS	1
	TIMEOUT		DS	1
	TLC0		DS	1
	TLC1		DS	1
	TLC2		DS	1
	FLAG1		DS	1
	FLAG2		DS	1
	TIMEH		DS	1
	TIMEG		DS	1
	DATA_IN		DS	1
	DATA_OUT	DS	1
	DATAH		DS	1
	DATAL		DS	1
	ADDRESSH	DS	1
	ADDRESSL	DS	1
	CRCT1		DS	1
	CRCT2		DS	1
	COUNT		DS	1
	MAC_H		DS	1
	MAC_L		DS	1
	FRONT_DELAY	DS	1
	TIME_DELAY_GAP	DS	1
	STARTADDRH		DS	1
	STARTADDRL		DS	1
;**************BIT_VARIABLES_DEFINNITIONS*******
	READTM_FLAG	EQU	FLAG1.0
	TIME_FLAG	EQU	FLAG1.3
	RESET_FLAG	EQU	FLAG1.1
	TM_EE_FLAG	EQU FLAG1.2
	DEFAULT_GAP_FLAG	EQU	FLAG1.4
	FILLOUT_FLAG	EQU	FLAG1.5
	I2CERROR_FLAG	EQU	FLAG1.6
	ASK_FLAG	EQU	FLAG1.7
	READ_LED_FLAG	EQU	FLAG2.1
	NOT_UPLOAD_FLAG	EQU	FLAG2.2
	HAVE_UPLOAD_FLAG EQU FLAG2.3
	NOT_QUICK_MODE_FLAG EQU FLAG2.4
	TM_I2C_EEROR	EQU FLAG2.5
	CLED_IO			EQU	P2.2
	SDATA_IO		EQU	P2.1
	SCL_IO			EQU	P2.0
	S_TM_EE_IO		EQU	P2.3
	PUSH_V_SENSOR_GND	EQU	P2.4
	SDA_IO			EQU	P2.5
	VTM_IO			EQU	P5.4
	VSR_IO			EQU	P0.0
	CLED_CONT		EQU	P2M.2
	SDATA_CONT		EQU	P2M.1
	SCL_CONT		EQU	P2M.0
	S_TM_EE_CONT	EQU	P2M.3
	SDA_CONT		EQU	P2M.5
	VTM_CONT		EQU	P5M.4
	VSR_CONT		EQU	P0M.0
;***************************************
	VDDF			EQU	P1.1
	S_VDD_VCC_IO		EQU	P1.0
	S_VDD_VCC_CONT		EQU	P1M.0
;*************CODE_SECTION**********************	
.CODE

		ORG	0
	JMP		START
		ORG	8H
	JMP		INT_SERVICE
INT_SERVICE:
;KEEP ACC AND PFLAG
	PUSH
;T0 INTERRUPT
JUST_T0:
	B0BTS0	FT0IEN
	B0BTS1	FT0IRQ
	JMP		JUST_TC0
	B0BCLR	FT0IRQ
;T0 INTERRUPT SERVISE PROGRESS
	B0BTS0	VDDF
	BSET 	NOT_UPLOAD_FLAG
	B0BTS0	VDDF
	BCLR    HAVE_UPLOAD_FLAG
;///////////////////////////////
	BTS1	HAVE_UPLOAD_FLAG
	JMP		$+3
	B0BTS1	VDDF
	BSET	NOT_QUICK_MODE_FLAG
	B0BTS1	VDDF
	BSET    HAVE_UPLOAD_FLAG
;//////////////////////////////////
	INCMS	TIMEH ;TIMEH=TIMEH+1,
	MOV		A,#TIME_GAP
	CMPRS	A,TIMEH
	JMP		EXIT_INT
	CLR		TIMEH
	BSET	TIME_FLAG
	INCMS	TIMEG
	MOV		A,TIME_DELAY_GAP
	CMPRS	A,TIMEG
	JMP		EXIT_INT
	CLR		TIMEG
	BSET	READTM_FLAG
	JMP		EXIT_INT
JUST_TC0:
	B0BTS0	FTC0IEN
	B0BTS1	FTC0IRQ
	JMP		JUST_INT0
	B0BCLR	FTC0IRQ
;TC0 INTERRUPT SERVICE PROGRESS
	JMP		EXIT_INT
JUST_INT0:
	B0BTS0	FP00IEN
	B0BTS1	FP00IRQ
	JMP EXIT_INT
	B0BCLR	FP00IRQ
;INT0 INTERRUPT SERVISE PROGRESS
EXIT_INT:
	POP
	RETI
;*********************************************************
;***********************STARRT**********************
START:
	MOV		A,#07FH
	B0MOV		STKP,A		;DISABLE GLOBAL INTERRUPT
	CLR		PFLAG
	MOV		A,#00H
	B0MOV		OSCM,A
	MOV		A,#0X5A
	B0MOV		WDTR,A	
	CALL		CLRRAM
STATE_INITIAL:
	CALL		DELAY_LED
	CALL		DELAY_LED
	CALL		DELAY_LED
	CALL		DELAY_LED
	CALL		SYS_INIT_FUN
	B0BCLR		FGIE
;******************SDATA+ VTM-******
	B0BSET		SDATA_CONT
	B0BCLR		SDATA_IO
	B0BCLR		CLED_CONT
	CALL		DELAY_LED
CLOCK_LOOP:
	CALL		DELAY_MINI
	B0BSET		SDATA_IO
	B0BCLR		VTM_IO
	B0BTS1		CLED_IO
	JMP			STATE_CHANGE
	CALL		DELAY_MINI
	B0BCLR		SDATA_IO
	B0BSET		VTM_IO
	JMP			CLOCK_LOOP
STATE_CHANGE:
	CALL		DELAY_LED
	CALL		DELAY_LED
	CALL		DELAY_LED
	CALL		DELAY_LED
	B0BSET		CLED_CONT
	MOV			A,#0X04
	MOV			CRCT1,A
STATE_CHANGE_LED:
	B0BCLR		CLED_IO
	CALL		DELAY_LED	
	B0BSET		CLED_IO
	CALL		DELAY_LED
	DECMS		CRCT1
	JMP			STATE_CHANGE_LED
	B0BCLR		CLED_CONT
SLOW_CLOCK_LOOP:
	CALL		DELAY_MINI
	CALL		DELAY_MINI
	B0BSET		SDATA_IO
	B0BCLR		VTM_IO
	B0BTS1		CLED_IO
	JMP			FAST_STATE_CHANGE
	CALL		DELAY_MINI
	CALL		DELAY_MINI
	B0BCLR		SDATA_IO
	B0BSET		VTM_IO
	JMP			SLOW_CLOCK_LOOP
FAST_STATE_CHANGE:
	CALL		DELAY_LED
	CALL		DELAY_LED
	CALL		DELAY_LED
	CALL		DELAY_LED
	B0BSET		CLED_CONT
	MOV			A,#0X05
	MOV			CRCT1,A
FAST_STATE_CHANGE_LED:
	B0BCLR		CLED_IO
	CALL		DELAY_LED	
	B0BSET		CLED_IO
	CALL		DELAY_LED
	DECMS		CRCT1
	JMP			FAST_STATE_CHANGE_LED
	B0BCLR		CLED_CONT
FAST_CLOCK_LOOP:
	CALL		CALL_DELAY
	CALL		CALL_DELAY
	B0BSET		SDATA_IO
	B0BCLR		VTM_IO
	B0BTS1		CLED_IO
	JMP			STATE_INITIAL
	CALL		CALL_DELAY
	CALL		CALL_DELAY
	B0BCLR		SDATA_IO
	B0BSET		VTM_IO
	JMP			FAST_CLOCK_LOOP
	
	
	
	
	
	
	
	
	
	
RESET_MODE:
	BSET	RESET_FLAG
	BCLR	FILLOUT_FLAG
	CLR		TIMEH
	CLR		TIMEG
	JMP		STATE_INITIAL
	
	
	
	
	
	
	
	
	
CLRRAM:
	
	CLR			Y
	MOV			A,#END_RAM_ADDR
	B0MOV		Z,A
CLRRAM10:
	CLR			@YZ
	DECMS		Z
	JMP			CLRRAM10
	CLR			@YZ
	RET
;***********************************
;***************************************
;*********************delay*****************
CALL_DELAY:
	RET
DELAY_MINI:;13US
	MOV		A,#0X05
	MOV		DELAYTIME1,A
DELAY0:
	DECMS	DELAYTIME1
	JMP		DELAY0
	RET
	
DELAY_SHORT:		;50US FOR 0.5US/INSTRUCTION
	MOV		A,#0X63
	MOV		DELAYTIME1,A
DELAY1:
	NOP
	DECMS	DELAYTIME1
	JMP		DELAY1
	RET
DELAY_LONG:	;>=5MS
;WAIT_FOR_A_LONG_WHILE
	MOV		A,#0X0A
	B0MOV	DELAYTIME1,A
DELAY2_1:
	MOV		A,#0XC7
	MOV		DELAYTIME2,A
DELAY2_2:
	NOP
	DECMS	DELAYTIME2
	JMP		DELAY2_2	
	DECMS	DELAYTIME1
	JMP		DELAY2_1
	RET		
DELAY_LED:		;0.2S
;WAIT_FOR_DEEP_DARK_FANTASY
	MOV		A,#0XFF
	MOV		DELAYTIME2,A
DELAY3_1:
	MOV		A,#0XFF
	MOV		DELAYTIME1,A
DELAY3_2:
	NOP
	NOP
	DECMS		DELAYTIME1
	JMP			DELAY3_2
	DECMS		DELAYTIME2
	JMP			DELAY3_1
	RET
OPEN_TC0_INT_FUN:
	B0BSET	FTC0CKS	;	OUTSIDE INPUT ACCIDENT
	B0BSET	FALOAD0 ;
	MOV		A,#0XFD
	B0MOV	TC0R,A
	B0MOV	TC0C,A
	B0BCLR	FTC0IRQ
	B0BSET	FTC0IEN
	B0BSET	FTC0ENB
	RET
SYS_INIT_FUN:
	MOV			A,#0X3D
	B0MOV		P2M,A
	MOV			A,#0X35
	B0MOV		P2,A
	;up resistor for p2.1
	;MOV			A,#0X02
	;B0MOV		P2UR,A
	MOV			A,#0X01
	B0MOV		P1M,A
	CLR			P1
	B0BSET		VSR_CONT
	B0BCLR		VSR_IO
	B0BSET		S_VDD_VCC_CONT
	B0BCLR		S_VDD_VCC_IO
	B0BSET		VTM_CONT
	B0BCLR		VTM_IO
	MOV			A,#0X03
	MOV			CRCT1,A
SYS_INIT_LED:
	B0BCLR		CLED_IO
	CALL		DELAY_LED	
	B0BSET		CLED_IO
	CALL		DELAY_LED
	DECMS		CRCT1
	JMP			SYS_INIT_LED
;************T0_INIT_START************************************
	MOV			A,#0X00
	B0MOV		T0M,A	
	B0BSET		FT0TB	; T0 = Fcpu/256,PERIOD TIME IS 2S
	CLR			T0C
	B0BCLR		FT0IRQ
	B0BCLR		FT0IEN
	B0BCLR		FT0ENB
;*****************TC0_INIT_START*****************
	CLR			TC0M
	CLR			TC0C
	B0BCLR		FTC0IRQ
	B0BCLR		FTC0IEN
	B0BCLR		FTC0ENB
;************************OPEN P1.1WEEK UP FUNCTION*********************
	MOV			A,#0X02
	B0MOV		P1W,A
	CALL		DELAY_MINI
	RET

	ENDP